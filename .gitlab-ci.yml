stages:
  - login
  - build
  
docker_login:
  stage: login
  image: "docker:latest"
  services:
    - name: docker:dind
      command: ["--tls=false", "--insecure-registry=harbor.host:8086"]  # Ton domaine ou IP Harbor
  variables:
    HARBOR_REGISTRY: "harbor.host:8086"
    DOCKER_TLS_CERTDIR: ""  # DÃ©sactive TLS entre le client et le daemon Docker DinD
  before_script:
    # Si ton Harbor est local, ajoute son IP au /etc/hosts
    - echo "192.168.88.116 harbor.host" >> /etc/hosts
  script:
    - echo "$HARBOR_PASSWORD" | docker login $HARBOR_REGISTRY -u "$HARBOR_USERNAME" --password-stdin
  only:
    - main

build_frontend:
  stage: build
  image: docker:24.0.5-cli
  services:
    - name: docker:24.0.5-dind
      command: ["--tls=false", "--insecure-registry=harbor.host:8086"]
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
  script:
    - echo "Adresse IP du conteneur DinD :"
    - docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -q -f "name=docker")
    - sleep 30
    - docker info
    - cd frontend
    - docker build -t harbor.host:8086/mardi/frontend:latest .
    - docker push harbor.host:8086/mardi/frontend:latest

build_backend:
  stage: build
  image: docker:24.0.5-cli
  services:
    - name: docker:24.0.5-dind
      command: ["--tls=false", "--insecure-registry=harbor.host:8086"]
  
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
  script:
    - sleep 30
    - docker info
    - cd backend
    - docker build -t harbor.host:8086/mardi/backend:latest .
    - docker push harbor.host:8086/mardi/backend:latest
