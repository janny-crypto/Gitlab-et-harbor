stages:
  - login
  - build
  - scan
  - push

.default_docker:
  image: docker:27
  services:
    - name: docker:27-dind
      alias: docker
      command: ["--tls=false", "--host=tcp://0.0.0.0:2375"]
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  before_script:
    - echo "üîß Docker info:"
    - docker info

docker_login:
  stage: login
  extends: .default_docker
  script:
    - echo "$HARBOR_PASSWORD" | docker login "http://$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" --password-stdin
  only:
    - main


# -------------------------
# üîµ BUILD FRONTEND IMAGE
# -------------------------
build_frontend:
  stage: build
  extends: .default_docker
  script:
    - echo "üì¶ Building frontend image..."
    - docker build -t frontend:latest ./frontend
    - docker tag frontend:latest $HARBOR_REGISTRY/$HARBOR_PROJECT/frontend:latest
  artifacts:
    paths:
      - frontend/
    expire_in: 1 day

# -------------------------
# üîµ BUILD BACKEND IMAGE
# -------------------------
build_backend:
  stage: build
  extends: .default_docker
  script:
    - echo "üì¶ Building backend image..."
    - docker build -t backend:latest ./backend
    - docker tag backend:latest $HARBOR_REGISTRY/$HARBOR_PROJECT/backend:latest
  artifacts:
    paths:
      - backend/
    expire_in: 1 day

# -------------------------
# üîç TRIVY SECURITY SCAN
# -------------------------
scan_images:
  stage: scan
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - echo "üîç Scanning frontend image..."
    - trivy image --exit-code 0 --severity HIGH,CRITICAL $HARBOR_REGISTRY/$HARBOR_PROJECT/frontend:latest

    - echo "üîç Scanning backend image..."
    - trivy image --exit-code 0 --severity HIGH,CRITICAL $HARBOR_REGISTRY/$HARBOR_PROJECT/backend:latest
  allow_failure: true
  dependencies:
    - build_frontend
    - build_backend

# -------------------------
# üöÄ PUSH IMAGES TO HARBOR
# -------------------------
push_images:
  stage: push
  extends: .default_docker
  script:
    - echo "$HARBOR_PASSWORD" | docker login $HARBOR_REGISTRY -u "$HARBOR_USERNAME" --password-stdin

    - echo "‚¨ÜÔ∏è Pushing frontend..."
    - docker push $HARBOR_REGISTRY/$HARBOR_PROJECT/frontend:latest

    - echo "‚¨ÜÔ∏è Pushing backend..."
    - docker push $HARBOR_REGISTRY/$HARBOR_PROJECT/backend:latest
  dependencies:
    - build_frontend
    - build_backend
