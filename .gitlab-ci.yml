stages:
  - login
  - scan
  - build
  - push

# ---------------------------------------------------------
# ðŸ”§ Variables globales
# ---------------------------------------------------------
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""     # surtout IMPORTANT !
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_VERIFY: "0"

  FRONT_IMAGE: $HARBOR_REGISTRY/$HARBOR_PROJECT/frontend
  BACK_IMAGE: $HARBOR_REGISTRY/$HARBOR_PROJECT/backend

default:
  image: docker:27
  services:
    - name: docker:27-dind
      alias: docker

# ---------------------------------------------------------
# ðŸŸ¦ 1) LOGIN DOCKER (Harbor)
# ---------------------------------------------------------
docker-login:
  stage: login
  script:
    - echo "$HARBOR_PASSWORD" | docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" --password-stdin
  only:
    - main
    - develop
    - merge_requests

# ---------------------------------------------------------
# ðŸŸ© 2) SCAN TRIVY (code source)
# ---------------------------------------------------------
scan-trivy:
  stage: scan
  image: aquasec/trivy:latest
  script:
    - trivy fs --exit-code 1 --severity HIGH,CRITICAL .
  needs:
    - docker-login
  only:
    - main
    - develop
    - merge_requests

# ---------------------------------------------------------
# ðŸŸ§ 3) BUILD FRONTEND
# ---------------------------------------------------------
build-frontend:
  stage: build
  needs: ["docker-login"]
  script:
    - docker build -t $FRONT_IMAGE:$CI_COMMIT_SHORT_SHA frontend/
    - docker tag $FRONT_IMAGE:$CI_COMMIT_SHORT_SHA $FRONT_IMAGE:latest

# ---------------------------------------------------------
# ðŸŸ¥ 4) BUILD BACKEND
# ---------------------------------------------------------
build-backend:
  stage: build
  needs: ["docker-login"]
  script:
    - docker build -t $BACK_IMAGE:$CI_COMMIT_SHORT_SHA backend/
    - docker tag $BACK_IMAGE:$CI_COMMIT_SHORT_SHA $BACK_IMAGE:latest

# ---------------------------------------------------------
# ðŸŸ¦ 5) PUSH DES IMAGES
# ---------------------------------------------------------
push-images:
  stage: push
  needs:
    - build-frontend
    - build-backend
    - docker-login
  script:
    - docker push $FRONT_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $FRONT_IMAGE:latest
    - docker push $BACK_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $BACK_IMAGE:latest
  only:
    - main
